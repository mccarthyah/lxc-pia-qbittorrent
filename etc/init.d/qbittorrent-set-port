#!/sbin/openrc-run

description="Extract PIA forwarded port and keep qBittorrent updated"

depend() {
    need net
    need pia-pf
    need qbittorrent
    after pia-pf qbittorrent
}

pidfile="/run/qbittorrent-set-port.pid"

LOG="/var/log/pia-pf.log"
PORT_FILE="/run/pia-port.txt"
QBT_URL="http://localhost:8080"
INTERVAL=600
STARTUP_DELAY=20

start() {
    ebegin "Starting qbittorrent-set-port"

    (
        sleep "$STARTUP_DELAY"
        last_port=""

        while true; do
            if [ -f "$LOG" ]; then
                port="$(tail -n 7 "$LOG" \
                    | head -n 1 \
                    | sed -r 's/\x1B\[[0-9;]*[mK]//g' \
                    | tr -cd '0-9')"

                if [ -n "$port" ] && [ "$port" != "$last_port" ]; then
                    echo "$port" > "$PORT_FILE"

                    curl -sf -X POST \
                        -d "json={\"listen_port\": $port}" \
                        "$QBT_URL/api/v2/app/setPreferences" \
                        >> /var/log/qbittorrent-set-port.log 2>&1

                    last_port="$port"
                fi
            fi

            sleep "$INTERVAL"
        done
    ) &

    echo $! > "$pidfile"
    eend 0
}

stop() {
    ebegin "Stopping qbittorrent-set-port"

    if [ -f "$pidfile" ]; then
        kill "$(cat "$pidfile")" 2>/dev/null
        rm -f "$pidfile"
    fi

    eend 0
}